<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Player Dramaku</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; width: 100vw; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #statusMsg { color: #FFF; font-family: sans-serif; font-size: 14px; position: absolute; text-align: center; }
        .error { color: #E50914 !important; font-weight: bold; }
    </style>
</head>
<body>

    <div id="statusMsg">Memuat Server... ‚è≥</div>
    <div id="videoContainer"></div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const bookId = params.get('id');
        const epNum = parseInt(params.get('ep')) || 1; 
        const platform = params.get('pl') || 'dramabox'; // Default dramabox kalau gak dikasih tau

        const statusMsg = document.getElementById('statusMsg');
        const videoContainer = document.getElementById('videoContainer');

        async function loadVideo() {
            try {
                if (!bookId) throw new Error("ID Film kosong Bosqu!");
                statusMsg.innerText = `Memuat Eps ${epNum} dari ${platform.toUpperCase()}... üîç`;

                let finalVideoUrl = "";
                let isHlsFormat = false;

                // ==========================================
                // JALUR 1: LOGIKA DRAMABOX (.mp4)
                // ==========================================
                if (platform === 'dramabox') {
                    const apiUrl = `https://api.sansekai.my.id/api/dramabox/allepisode?bookId=${bookId}&lang=in`;
                    const res = await fetch(apiUrl);
                    const data = await res.json();
                    
                    let episodes = Array.isArray(data) ? data : (data.data || data.result || []);
                    if (episodes.length === 0) throw new Error("Data DramaBox kosong.");

                    // Lapor Total Episode ke Android
                    if (window.Android && window.Android.setTotalEpisodes) {
                        window.Android.setTotalEpisodes(episodes.length);
                    }

                    const targetIndex = epNum - 1;
                    if (targetIndex < 0 || targetIndex >= episodes.length) throw new Error(`Episode ${epNum} belum rilis.`);
                    
                    const epsData = episodes[targetIndex];
                    if (epsData.cdnList && epsData.cdnList[0].videoPathList) {
                        const hdVideo = epsData.cdnList[0].videoPathList.find(v => v.quality === 1080);
                        finalVideoUrl = hdVideo ? hdVideo.videoPath : epsData.cdnList[0].videoPathList[0].videoPath;
                    }

                // ==========================================
                // JALUR 2: LOGIKA REELSHORT (.m3u8)
                // ==========================================
                } else if (platform === 'reelshort') {
                    // A. Ambil Detail buat tau Total Episode
                    const detailUrl = `https://api.sansekai.my.id/api/reelshort/detail?bookId=${bookId}`;
                    const detailRes = await fetch(detailUrl);
                    const detailData = await detailRes.json();
                    
                    if (detailData.totalEpisodes) {
                        if (window.Android && window.Android.setTotalEpisodes) {
                            window.Android.setTotalEpisodes(detailData.totalEpisodes);
                        }
                    }

                    // B. Ambil URL Video spesifik per Episode (Sistem Anti-Spam)
                    const epsUrl = `https://api.sansekai.my.id/api/reelshort/episode?bookId=${bookId}&episodeNumber=${epNum}`;
                    const epsRes = await fetch(epsUrl);
                    const epsData = await epsRes.json();

                    if (!epsData.videoList || epsData.videoList.length === 0) {
                        throw new Error(`Video Reelshort Eps ${epNum} tidak ditemukan/dikunci.`);
                    }

                    // Cari kualitas terbaik (biasanya 720/1080)
                    const goodVideo = epsData.videoList.find(v => v.quality >= 720);
                    finalVideoUrl = goodVideo ? goodVideo.url : epsData.videoList[0].url;
                    isHlsFormat = true; // Tandai kalau ini butuh mesin HLS.js
                }

                if (!finalVideoUrl) throw new Error("Gagal mengekstrak link video.");

                // ==========================================
                // MUNCULKAN VIDEO KE LAYAR
                // ==========================================
                statusMsg.style.display = 'none'; 
                videoContainer.innerHTML = `<video id="myVideo" controls autoplay playsinline></video>`;
                const videoElement = document.getElementById('myVideo');

                // Lapor kalau video habis (Biar bisa Swipe Next otomatis)
                videoElement.onended = function() { 
                    if (window.Android && window.Android.onVideoEnded) window.Android.onVideoEnded(); 
                };

                // Mesin Pemutar
                if (isHlsFormat) {
                    if (Hls.isSupported()) {
                        const hls = new Hls();
                        hls.loadSource(finalVideoUrl);
                        hls.attachMedia(videoElement);
                        hls.on(Hls.Events.MANIFEST_PARSED, function() { videoElement.play(); });
                    } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                        // Fallback buat browser bawaan yang udah support m3u8
                        videoElement.src = finalVideoUrl;
                        videoElement.play();
                    }
                } else {
                    // Putar .mp4 biasa
                    videoElement.src = finalVideoUrl;
                    videoElement.play();
                }

            } catch (error) {
                statusMsg.innerHTML = `‚ùå Error:<br>${error.message}`;
                statusMsg.classList.add('error');
            }
        }

        loadVideo();
    </script>
</body>
</html>
