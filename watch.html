<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dramaku Player</title>
    <style>
        body { margin: 0; background-color: #000; color: #fff; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: contain; }
        
        /* Tampilan Loading Keren */
        .status-layer { position: absolute; text-align: center; z-index: 10; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; width: 80%; max-width: 400px; }
        .hidden { display: none !important; }
        .btn-retry { margin-top: 15px; padding: 10px 20px; background: #e50914; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        h2 { margin: 0 0 10px 0; font-size: 18px; color: #e50914; }
        small { color: #aaa; }
    </style>
</head>
<body>

    <div class="status-layer" id="statusBox">
        <h2 id="msgTitle">üì° Menghubungi Satelit...</h2>
        <small id="msgDetail">Mencari ID Film...</small>
        <br>
        <button class="btn-retry hidden" id="btnRetry" onclick="location.reload()">COBA LAGI</button>
    </div>

    <video id="myVideo" controls autoplay playsinline>
        Browser HP kamu tidak support video HTML5.
    </video>

    <script>
        // --- 1. SETTINGAN DARI FILE JS LAMA KAMU ---
        // Diambil dari file: probe_sansekai_v2.js
        const BASE_API = 'https://api.sansekai.my.id/api/dramabox/allepisode';

        // --- 2. AMBIL PARAMETER DARI ANDROID ---
        const params = new URLSearchParams(window.location.search);
        const bookId = params.get('id');       // ID Film
        let targetEp = params.get('ep') || 1;  // Episode target (Default 1)
        targetEp = parseInt(targetEp);         // Pastikan jadi angka

        // Elemen UI
        const statusBox = document.getElementById('statusBox');
        const msgTitle = document.getElementById('msgTitle');
        const msgDetail = document.getElementById('msgDetail');
        const btnRetry = document.getElementById('btnRetry');
        const videoPlayer = document.getElementById('myVideo');

        // Update Info Awal
        msgDetail.innerText = "ID: " + bookId + " | Episode: " + targetEp;

        // --- 3. LOGIKA UTAMA (ADAPTASI DARI probe_sansekai_v2.js) ---
        async function fetchSansekai() {
            try {
                // Susun URL sesuai file js lama kamu
                const apiUrl = `${BASE_API}?bookId=${bookId}&lang=in`;
                console.log("Nembak API: " + apiUrl);

                const response = await fetch(apiUrl);
                
                if (!response.ok) throw new Error("Gagal Konek API (" + response.status + ")");

                const jsonResult = await response.json();

                // LOGIKA CERDAS: Mencari Array Episode (karena struktur API bisa berubah)
                // Ini logika dari file probe_sansekai_v2.js baris 108-114
                let episodes = [];
                if (Array.isArray(jsonResult)) {
                    episodes = jsonResult;
                } else if (jsonResult.data && Array.isArray(jsonResult.data)) {
                    episodes = jsonResult.data;
                } else if (jsonResult.result && Array.isArray(jsonResult.result)) {
                    episodes = jsonResult.result;
                }

                if (episodes.length === 0) {
                    throw new Error("Daftar Episode Kosong / ID Salah");
                }

                // --- 4. CARI LINK VIDEO TARGET ---
                msgTitle.innerText = "üîç Mencari Link Video...";
                
                // Cari episode yang nomornya cocok dengan targetEp
                const foundEp = episodes.find(item => {
                    // Cek berbagai kemungkinan nama key (no, episode, id)
                    let epNum = item.episode || item.no || item.chapter || item.index;
                    return parseInt(epNum) === targetEp;
                });

                if (foundEp) {
                    // Link ketemu! Ambil URL-nya
                    // Cek berbagai kemungkinan nama key url (videoUrl, url, streamUrl)
                    const videoUrl = foundEp.videoUrl || foundEp.url || foundEp.stream || foundEp.playUrl;

                    if (videoUrl) {
                        // SUKSES! MAINIKAN VIDEO üé¨
                        msgTitle.innerText = "‚úÖ Video Ditemukan!";
                        msgTitle.style.color = "#46d369"; // Hijau
                        console.log("Memutar: " + videoUrl);

                        videoPlayer.src = videoUrl;
                        
                        // Sembunyikan loading setelah video siap
                        videoPlayer.oncanplay = () => {
                            statusBox.classList.add('hidden');
                        };
                        
                        // Paksa Play
                        var playPromise = videoPlayer.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(error => {
                                console.log("Autoplay dicegah, nunggu user klik.");
                            });
                        }

                    } else {
                        throw new Error("Link Video di Episode ini NULL/Kosong.");
                    }

                } else {
                    throw new Error(`Episode ${targetEp} belum rilis / tidak ditemukan.`);
                }

            } catch (error) {
                console.error(error);
                msgTitle.innerText = "‚ùå Gagal Memutar";
                msgDetail.innerText = error.message;
                btnRetry.classList.remove('hidden'); // Munculkan tombol refresh
            }
        }

        // --- EKSEKUSI ---
        if (bookId) {
            fetchSansekai();
        } else {
            msgTitle.innerText = "‚õî Error ID";
            msgDetail.innerText = "Tidak ada ID Film yang dikirim.";
        }
    </script>
</body>
</html>
