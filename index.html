<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DramaBox UNLOCKED (Sansekai API)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #141414; color: white; font-family: sans-serif; }
        .poster-container { transition: transform 0.3s; }
        .poster-container:hover { transform: scale(1.05); z-index: 10; cursor: pointer; }
        
        /* SCROLLBAR CUSTOM */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #141414; }
        /* PERBAIKAN 1: Mengganti 'rounded' menjadi 'border-radius' */
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #db0000; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-[#141414] min-h-screen">

    <nav class="fixed top-0 w-full z-40 bg-gradient-to-b from-black to-transparent px-8 py-6 flex justify-between items-center">
        <h1 class="text-4xl font-extrabold text-red-600 tracking-tighter drop-shadow-lg flex items-end">
                DRAM
                <span class="text-6xl text-white mx-[1px] -mb-1 drop-shadow-[0_0_15px_rgba(255,255,255,0.4)]">AK</span>
                U<span class="text-white"></span> <span class="text-xs bg-yellow-500 text-black px-1 rounded ml-1">VIP</span></h1>
        <input type="text" id="searchInput" placeholder="Cari Judul..." class="bg-black/50 border border-gray-600 rounded-full py-2 px-4 w-64 text-white placeholder-gray-400 backdrop-blur-sm focus:outline-none focus:border-red-600">
    </nav>

    <main class="pt-24 px-8 pb-10">
        <div id="loadingText" class="text-center mt-20 text-gray-500 animate-pulse">Sedang memuat katalog film...</div>
        <div id="movieGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 gap-y-8"></div>
    </main>

    <div id="playerModal" class="fixed inset-0 z-50 hidden bg-black/95 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#181818] w-full max-w-6xl rounded-xl overflow-hidden shadow-2xl flex flex-col max-h-[95vh] h-full lg:h-auto">
            
            <div class="flex justify-between items-center p-4 border-b border-gray-700 shrink-0">
                <h2 id="modalTitle" class="text-xl font-bold truncate pr-4 text-white">Judul Drama</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white text-3xl leading-none" aria-label="Tutup Modal">&times;</button>
            </div>

            <div class="flex flex-col lg:flex-row h-full overflow-hidden">
                
                <div class="flex-1 bg-black flex flex-col relative group">
                    <div class="relative w-full h-full flex items-center justify-center bg-black">
                        <video id="videoPlayer" controls autoplay class="w-full h-full max-h-[60vh] lg:max-h-[70vh] object-contain"></video>
                    </div>
                    
                    <div class="bg-[#181818] p-3 flex justify-between items-center border-t border-gray-700">
                        <span id="currentEpTitle" class="text-sm text-gray-400 font-bold">Episode -</span>
                        <button id="btnNext" onclick="playNextEpisode()" class="bg-gray-700 hover:bg-white hover:text-black text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            Next Episode ⏭
                        </button>
                    </div>
                </div>

                <div class="w-full lg:w-80 bg-[#1f1f1f] border-l border-gray-700 flex flex-col h-64 lg:h-auto shrink-0">
                    <div class="p-4 border-b border-gray-700">
                        <h3 class="font-bold text-gray-300">Pilih Episode</h3>
                        <p id="totalEpisodes" class="text-xs text-gray-500">Loading...</p>
                        
                        <select id="qualitySelect" onchange="changeQuality()" aria-label="Pilih Kualitas Video" title="Pilih Kualitas Video" class="mt-2 w-full bg-gray-800 text-xs text-white p-1 rounded border border-gray-600">
                            <option value="720">720p (HD)</option>
                            <option value="540">540p (SD)</option>
                            <option value="1080">1080p (FHD)</option>
                        </select>
                    </div>
                    <div id="episodeList" class="flex-1 overflow-y-auto p-2 grid grid-cols-4 gap-2 content-start"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SANSEKAI_API = 'https://api.sansekai.my.id/api/dramabox/allepisode';
        let allMovies = [];
        let currentChapters = []; 
        let currentIndex = -1;    
        let currentQuality = 720; 

        // LOAD KATALOG
        fetch('catalog.json')
            .then(res => res.json())
            .then(data => {
                allMovies = data;
                document.getElementById('loadingText').style.display = 'none';
                renderMovies(data);
            })
            .catch(err => {
                document.getElementById('loadingText').innerText = "Gagal memuat catalog.json";
            });

        function renderMovies(movies) {
            const grid = document.getElementById('movieGrid');
            grid.innerHTML = '';
            movies.forEach(m => {
                const el = document.createElement('div');
                el.className = 'poster-container group relative rounded-md overflow-hidden bg-[#2f2f2f] aspect-[2/3]';
                el.onclick = () => openMovie(m);
                const coverImg = m.cover || 'https://via.placeholder.com/300x450';
                el.innerHTML = `
                    <img src="${coverImg}" loading="lazy" class="w-full h-full object-cover opacity-90 group-hover:opacity-100" alt="${m.title}">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-80"></div>
                    <div class="absolute bottom-0 p-3 w-full">
                        <p class="text-white font-bold text-sm line-clamp-2">${m.title}</p>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-yellow-400 text-xs font-bold">${m.rating ? '★ '+m.rating : ''}</span>
                            <span class="text-gray-400 text-xs bg-gray-800 px-1 rounded">VIP</span>
                        </div>
                    </div>
                `;
                grid.appendChild(el);
            });
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            renderMovies(allMovies.filter(m => m.title.toLowerCase().includes(term)));
        });

        async function openMovie(movie) {
            const modal = document.getElementById('playerModal');
            const epList = document.getElementById('episodeList');
            
            modal.classList.remove('hidden');
            document.getElementById('modalTitle').innerText = movie.title;
            epList.innerHTML = '<div class="col-span-4 flex justify-center py-10"><div class="loader"></div><p class="text-xs text-center mt-2 text-gray-500 w-full">Unlocking VIP...</p></div>';
            resetPlayer();

            try {
                const url = `${SANSEKAI_API}?bookId=${movie.bookId}&lang=in`;
                const res = await fetch(url);
                const json = await res.json();
                
                if (Array.isArray(json)) {
                    currentChapters = json;
                } else if (json.result && Array.isArray(json.result)) {
                    currentChapters = json.result;
                } else if (json.data && Array.isArray(json.data)) {
                    currentChapters = json.data;
                } else {
                    currentChapters = [];
                }

                document.getElementById('totalEpisodes').innerText = `${currentChapters.length} Episode VIP Terbuka`;
                renderEpisodeButtons();

                if (currentChapters.length > 0) {
                    playEpisodeByIndex(0); 
                } else {
                    epList.innerHTML = '<div class="col-span-4 text-center text-red-500">Gagal ambil episode (API Error/Limit).</div>';
                }

            } catch (err) {
                epList.innerHTML = '<div class="col-span-4 text-center text-red-500">Gagal koneksi API Sansekai</div>';
                console.error(err);
            }
        }

        function renderEpisodeButtons() {
            const epList = document.getElementById('episodeList');
            epList.innerHTML = '';

            currentChapters.forEach((ep, index) => {
                const btn = document.createElement('button');
                const label = `EP ${index + 1}`;
                
                btn.id = `btn-ep-${index}`;
                btn.className = `p-2 rounded text-xs font-bold truncate transition-colors bg-gray-700 hover:bg-red-600 text-gray-200`;
                btn.innerText = label;
                btn.onclick = () => playEpisodeByIndex(index);
                epList.appendChild(btn);
            });
        }

        function playEpisodeByIndex(index) {
            if (index < 0 || index >= currentChapters.length) return;

            currentIndex = index;
            const ep = currentChapters[index];
            const video = document.getElementById('videoPlayer');
            const titleLabel = document.getElementById('currentEpTitle');

            let streamUrl = "";
            if (ep.cdnList) {
                let allSources = [];
                ep.cdnList.forEach(cdn => {
                    if(cdn.videoPathList) allSources = allSources.concat(cdn.videoPathList);
                });
                
                let targetVid = allSources.find(v => v.quality == currentQuality);
                if (!targetVid) targetVid = allSources.find(v => v.quality == 720);
                if (!targetVid && allSources.length > 0) targetVid = allSources[0];

                if (targetVid) streamUrl = targetVid.videoPath;
            }

            if (!streamUrl && ep.videoPath) streamUrl = ep.videoPath;

            if (!streamUrl) {
                alert("Link video episode ini kosong/rusak dari sumbernya.");
                return;
            }

            console.log(`Playing Eps ${index+1} [${currentQuality}p]: ${streamUrl}`);
            video.src = streamUrl;
            video.play();
            titleLabel.innerText = `Sedang memutar: EP ${index + 1}`;

            document.querySelectorAll('#episodeList button').forEach(b => {
                b.className = 'bg-gray-700 text-gray-200 p-2 rounded text-xs font-bold truncate';
            });
            const activeBtn = document.getElementById(`btn-ep-${index}`);
            if(activeBtn) activeBtn.className = 'bg-red-600 text-white p-2 rounded text-xs font-bold truncate border border-red-400';

            const btnNext = document.getElementById('btnNext');
            if (index >= currentChapters.length - 1) {
                btnNext.disabled = true;
                btnNext.innerText = "Tamat";
            } else {
                btnNext.disabled = false;
                btnNext.innerText = "Next Episode ⏭";
            }
        }

        function changeQuality() {
            const select = document.getElementById('qualitySelect');
            currentQuality = select.value;
            console.log("Ganti kualitas ke:", currentQuality);
            if (currentIndex !== -1) {
                const video = document.getElementById('videoPlayer');
                const currentTime = video.currentTime;
                playEpisodeByIndex(currentIndex);
                video.currentTime = currentTime; // Restore waktu tonton
            }
        }

        document.getElementById('videoPlayer').addEventListener('ended', () => {
            playNextEpisode();
        });

        function playNextEpisode() {
            if (currentIndex < currentChapters.length - 1) {
                playEpisodeByIndex(currentIndex + 1);
            }
        }

        function resetPlayer() {
            const vid = document.getElementById('videoPlayer');
            vid.pause();
            vid.src = "";
            currentIndex = -1;
            document.getElementById('currentEpTitle').innerText = "Memuat...";
        }

        function closeModal() {
            document.getElementById('playerModal').classList.add('hidden');
            resetPlayer();
        }
    </script>
</body>
</html>